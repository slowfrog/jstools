<project name="build-base" default="all">

  <dirname property="build-base.basedir" file="${ant.file.build-base}" />

  <target name="all" depends="clean, compile, test"
          description="Cleans, compiles and tests" />
  
  <target name="clean">
    <delete dir="testoutput" failonerror="no" />
    <delete dir="testoutput_compiled" failonerror="no" />
    <delete dir="testoutput_advanced" failonerror="no" />
    <delete dir="compiled" failonerror="no" />
    <delete dir="advanced" failonerror="no" />
  </target>

  <target name="pre-init" />
  
  <target name="init"
          description="Initializes the build, define macros..."
          depends="pre-init">

    <taskdef resource="net/sf/antcontrib/antcontrib.properties">
      <classpath>
        <pathelement location="${build-base.basedir}/ant-contrib-1.0b3.jar" />
      </classpath>
    </taskdef>
    
    <macrodef name="closure">
      <attribute name="level" default="SIMPLE_OPTIMIZATIONS" />
      <attribute name="files" />
      <attribute name="output" default="compiled/${ant.project.name}_compiled.js" />
      <element name="extra" optional="yes" implicit="yes" />
      <sequential>
        <java jar="${build-base.basedir}/closure.jar" fork="true" failonerror="yes">
          <arg line="@{files}" />
          <arg value="--compilation_level=@{level}" />
          <arg value="--js_output_file=@{output}" />
          <arg value="--summary_detail_level=3" />
          <extra />
        </java>
      </sequential>
    </macrodef>
    
    <macrodef name="jstest">
      <attribute name="destdir" default="testoutput" />
      <attribute name="auto-conf" default="yes" />
      <attribute name="conf" default="jsTestDriver.conf" />
      <attribute name="files" />
      <attribute name="serve" default="" />
      <sequential>
        <if>
          <istrue value="@{auto-conf}" />
          <then>
            <copy file="${build-base.basedir}/template_jsTestDriver.conf" tofile="@{conf}"
                  overwrite="yes">
              <filterset>
                <filter token="FILES" value="@{files}" />
                <filter token="SERVE" value="@{serve}" />
              </filterset>
            </copy>
          </then>
        </if>
        <mkdir dir="@{destdir}" />
        <java jar="${build-base.basedir}/JsTestDriver-1.3.3b.jar" fork="true">
          <arg value="--config" /><arg value="@{conf}" />
          <arg value="--tests" /><arg value="all" />
          <arg value="--testOutput" /><arg value="@{destdir}" />
        </java>
        <junitreport>
          <fileset dir="@{destdir}" includes="TEST-*.xml" />
          <report format="frames" todir="@{destdir}" />
        </junitreport>
      </sequential>
    </macrodef>

    <!-- Predefined properties -->
    <fileset id="sources.fileset" dir="." includes="*.js" />
    <property name="sources" refid="sources.fileset" />
    <fileset id="test.fileset" dir="." includes="test/*.js" />
    <property name="test.sources" refid="test.fileset" />
    <property name="all.sources" value="${sources};${test.sources}" />
  </target>

  <target name="test"
          description="Launch unit tests on handwritten and compiled code"
          depends="test-standard, test-compiled" />

  <target name="test-standard"
          description="Launch unit tests on handwritten code"
          depends="init">
    <propertyregex property="jstest.src" input="${all.sources}" global="yes"
                   regexp="(^)|([;,])" replace="${line.separator}  - " />
    <!--echo message="jstest.src=${jstest.src}" /-->
    <jstest files="${jstest.src}" />
  </target>

  <target name="compile"
          description="Pass the code through the Closure compiler"
          depends="init">
    <propertyregex property="closure.src" input="${sources}" global="yes"
                   regexp="(^)|([;,])" replace=" --js=" />

    <mkdir dir="compiled"/>
    <closure files="${closure.src}" />
  </target>
  
  <target name="test-compiled"
          description="Launch unit tests on compiled code"
          depends="init">
    <property name="compiled.test.sources"
              value="compiled/${ant.project.name}_compiled.js;${test.sources}" />
    <propertyregex property="compiled.jstest.src" input="${compiled.test.sources}" global="yes"
                   regexp="(^)|([;,])" replace="${line.separator}  - " />
    <jstest files="${compiled.jstest.src}"
            conf="jsTestDriverCompiled.conf"
            destdir="testoutput_compiled" />
  </target>

  <target name="advanced"
          description="Compile and test with the closure compiler advanced optimizations"
          depends="compile-advanced, test-advanced" />
  
  <target name="compile-advanced"
          description="Pass the code through the Closure compiler in advanced mode"
          depends="init">
    <propertyregex property="closure.src" input="${sources}" global="yes"
                   regexp="(^)|([;,])" replace=" --js=" />

    <mkdir dir="advanced"/>
    <closure level="ADVANCED_OPTIMIZATIONS"
             files="${closure.src}"
             output="advanced/${ant.project.name}_advanced.js">
            <arg line="--jscomp_error accessControls" />
            <arg line="--jscomp_error ambiguousFunctionDecl" />
            <arg line="--jscomp_error checkRegExp" />
            <arg line="--jscomp_error checkTypes" />
            <arg line="--jscomp_error checkVars" />
            <arg line="--jscomp_error constantProperty" />
            <arg line="--jscomp_error deprecated" />
            <arg line="--jscomp_error es5Strict" />
            <arg line="--jscomp_error externsValidation" />
            <arg line="--jscomp_error fileoverviewTags" />
            <arg line="--jscomp_error globalThis" />
            <arg line="--jscomp_error internetExplorerChecks" />
            <arg line="--jscomp_error invalidCasts" />
            <arg line="--jscomp_error missingProperties" />
            <arg line="--jscomp_error nonStandardJsDocs" />
            <arg line="--jscomp_error strictModuleDepCheck" />
            <arg line="--jscomp_error typeInvalidation" />
            <arg line="--jscomp_error undefinedVars" />
            <arg line="--jscomp_error unknownDefines" />
            <arg line="--jscomp_error uselessCode" />
            <arg line="--jscomp_error visibility" />
    </closure>

  </target>
  
  <target name="test-advanced"
          description="Pass the code through the advanced Closure compiler"
          depends="init">
    <property name="advanced.test.sources"
              value="${sources};${test.sources}" />
    <propertyregex property="advanced.src" input="${advanced.test.sources}" global="yes"
                   regexp="(^)|([;,])" replace=" --js=" />
    <mkdir dir="advanced"/>
    <closure level="ADVANCED_OPTIMIZATIONS"
             files="${advanced.src}"
             output="advanced/tests.js">
    </closure>
    <jstest files="  - advanced/tests.js"
            conf="jsTestDriverAdvanced.conf"
            destdir="testoutput_advanced" />
  </target>
    
</project>